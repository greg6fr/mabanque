pipeline {
    // Spécifier que le pipeline peut s'exécuter sur n'importe quel agent
    agent any

    // Déclarer les variables d'environnement utilisées dans le pipeline
    environment {
        GIT_REPO = "https://github.com/greg6fr/mabanque.git"
        NODE_VERSION = "20"
    }

    stages {
        // 1. Cloner le dépôt
        stage('Cloner le dépôt') {
            steps {
                echo "Clonage du dépôt Github"
                git branch: 'main', url: "${GIT_REPO}"
            }
        }

        // 2. Installer Node.js
        stage('Installer Node.js') {
            steps {
                echo "Installation de Node.js"
                sh '''
                    # Mettre à jour les paquets
                    apt update && apt upgrade -y

                    # Installer les dépendances nécessaires
                    apt install -y curl ca-certificates gnupg

                    # Ajouter le référentiel Node.js et installer la version spécifiée
                    curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | sudo -E bash -
                    apt install -y nodejs

                    # Vérifier l'installation
                    node -v
                    npm -v
                '''
            }
        }

        // 3. Installer les dépendances Angular
        stage('Installer les dépendances Angular') {
            steps {
                echo 'Installation des dépendances Angular'
                sh 'npm install'
            }
        }

        // 4. Construire l'application
        stage('Construire l\'application') {
            steps {
                echo 'Construction de l\'application Angular en mode production'
                sh 'npm run build'
            }
        }

        // 5. Afficher les fichiers générés
        stage('Afficher les fichiers générés') {
            steps {
                echo 'Liste des fichiers générés dans le dossier dist/mabanque'
                sh 'ls -al dist/mabanque'
            }
        }
    }

    // Étapes post-pipeline
    post {
        always {
            echo 'Pipeline terminé.'
        }
    }
}
